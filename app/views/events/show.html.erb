<!DOCTYPE html>
<html>
  <head>
    <title>Bunny Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="turbolinks-cache-control" content="no-cache">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        width: 100%;
        height: 400px;
        background-color: #666;
        /* position: absolute; */
        top: 0px;
        right: 0px;
        left: 0px;
        bottom: 0;
        /* margin: auto; */
      }

      .event-img {
        width: 100%;
      }
    </style>
    
  </head>
  <body>

    <div class="event-img">
      <%= activity_img(@event) %>
    </div>
   

    <%= simple_form_for @event do |f| %>
    <table class="table">

      <thead>
        <tr>
          <th scope="col"><h2><%= f.object.event_name %></h2></th>
          <td>主揪：
            <%= link_to owner_event_path do %>
              <%= avatar_tag(@event.owner, size: '50x50') %>
            <% end %>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">報名截止</th>
          <td colspan="2"><%= f.object.apply_end %></td>
        </tr>
        <tr>
          <th scope="row">活動種類</th>
          <td><%= f.object.event_type %></td>
        </tr>
        <tr>
          <th scope="row">活動開始日期與時間</th>
          <td><%= f.object.event_start %></td>
        </tr>
                <tr>
          <th scope="row">活動結束日期與時間</th>
          <td><%= f.object.event_end %></td>
        </tr>
        <tr>
          <th scope="row">揪團人數(最低成團人數)</th>
          <td><%= f.object.min_attend %>人</td>
        </tr>
        <tr>
          <th scope="row">活動說明</th>
          <td><%= f.object.description %></td>
        </tr>
        <tr>
          <th scope="row">活動地址</th>
          <td><span id="location2"><%= f.object.location %></span></td>
        </tr>
      </tbody>
    </table>
    <% end %>

    <div id="map"></div>
    <% if user_signed_in? && policy(@event).view_participants? %>
      <%= link_to "檢視團員名單", view_participants_event_path(@event), class: "btn btn-info"%>
    <% end %>
    <% if user_signed_in? && policy(@event).edit? %>
      <%= link_to "編輯活動", edit_event_path(@event), class: "btn btn-primary"%>
      <%= link_to "取消活動", cancel_event_event_path(@event), class: "btn btn-dark", data: {confirm: "確定取消活動？"}, method: 'put' %>
    <% end %>

    <% if user_signed_in? && policy(@event).close_event? %>
      <%= link_to "收團！確認出團！", close_event_event_path(@event), class: "btn btn-danger", method: 'put', data: {confirm: "確定收團？不再多找些人？"} %>
    <% end %>

    <% if policy(@event).apply? %>
      <%= link_to "我要報名", apply_event_path, class: "btn btn-success", method: 'put' %>
    <% end %>

    <!-- Button trigger modal -->
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#exampleModalCenter">
      <i class="fas fa-share-alt"></i>
    </button>

    <!-- Modal -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalCenterTitle">和朋友分享</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            
            <%= text_field_tag(:text, value="#{ @link }", class: "qr-link") %><br />
            <div id="qrcode"></div>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <hr />

    <!-- 留言區 -->
    <h3>留言區</h3>
    <hr />
    <%= render partial: 'events/comment', collection: @event.comments.reverse %>
    <hr />
    <%= render partial: 'comments/form' %>


    <script>
      var map, lat1, lng2;
      function initMap() {

        geocoder = new google.maps.Geocoder();
        var directionsService = new google.maps.DirectionsService();
        var directionsDisplay = new google.maps.DirectionsRenderer();
        // 載入路線服務與路線顯示圖層
        
        navigator.geolocation.watchPosition((position) => {
          console.log(position.coords);
          lat1 = position.coords.latitude;
          lng2 = position.coords.longitude;

          position2(lat1,lng2);
        });
        // 初始化地圖

        function position2(lat1, lng2) {   
          map = new google.maps.Map(document.getElementById('map'), {
              zoom: 16,
              center: { lat: 25.034010, lng: 121.562428 }
          });

          var address = document.querySelector("#location2").innerHTML;
          console.log(address)

          // 放置路線圖層
          directionsDisplay.setMap(map);

          // 路線相關設定
          var request = {
              origin: { lat: lat1, lng: lng2},
              destination: address,
              travelMode: 'TRANSIT'
          };
          // 繪製路線
          directionsService.route(request, function (result, status) {
            if (status == 'OK') {
              // 回傳路線上每個步驟的細節
              console.log(result.routes[0].legs[0].steps);
              directionsDisplay.setDirections(result);
            } 
            else {
              console.log(status);
            }
          });
        }
    }
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=<%=ENV["google_api_key"]%>&callback=initMap"
    async defer></script>
  </body>
</html>


